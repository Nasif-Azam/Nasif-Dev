name: Fabric Deployment Pipeline

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual trigger from Actions tab

jobs:
  deploy:
    runs-on: windows-latest
    
    steps:
    # ================================================================
    # Step 1: Checkout Repository
    # ================================================================
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ================================================================
    # Step 2: Setup Python
    # ================================================================
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    # ================================================================
    # Step 3: Install Git (Windows runners may need explicit setup)
    # ================================================================
    - name: Verify Git installation
      run: |
        git --version
        Write-Host "Git is available"

    # ================================================================
    # Step 4: Upgrade pip and install dependencies
    # ================================================================
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        Write-Host "Dependencies installed successfully"

    # ================================================================
    # Step 5: Run Fabric Deployment Script
    # ================================================================
    - name: Deploy to Fabric
      run: python fabric_deploy_copy.py

    # ================================================================
    # Step 6: Upload Deployment Report as Artifact
    # ================================================================
    - name: Upload deployment report
      if: always()  # Run even if previous steps fail
      uses: actions/upload-artifact@v4
      with:
        name: deployment-report
        path: deployment_report.json
        retention-days: 30

    # ================================================================
    # Step 7: Post Deployment Status
    # ================================================================
    - name: Deployment Status
      if: success()
      run: |
        Write-Host "✓ Deployment completed successfully!" -ForegroundColor Green
        Write-Host "Check the deployment_report.json artifact for details"

    - name: Deployment Failed
      if: failure()
      run: |
        Write-Host "✗ Deployment failed. Please review the logs above." -ForegroundColor Red
        exit 1